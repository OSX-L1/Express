<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โปรแกรมสร้างใบปะหน้าจัดส่งสินค้า</title>
    <!-- โหลด Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- โหลดฟอนต์ Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- โหลด External Libraries: Firebase, html2canvas, jspdf -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* กำหนดให้ใช้ฟอนต์ Sarabun ทั่วทั้งแอปพลิเคชัน */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f3f4f6;
        }
        /* สไตล์สำหรับใบปะหน้าใน Modal */
        #print-area {
            /* กำหนดขนาดที่ใกล้เคียงกับ A6/A5 สำหรับใบปะหน้า */
            width: 105mm; /* A6 width */
            min-height: 148mm; /* A6 height */
            box-sizing: border-box;
        }
        /* สไตล์สำหรับซ่อนส่วนหัวและท้ายกระดาษในการพิมพ์ */
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
                /* ปรับขนาดให้เต็มหน้ากระดาษพิมพ์ */
                width: 100%; 
                height: auto;
                position: absolute;
                left: 0;
                top: 0;
                margin: 0;
                padding: 1cm;
                box-shadow: none;
            }
            /* ซ่อนปุ่มและข้อความที่ไม่จำเป็นในการพิมพ์ */
            #print-area button, #print-area-container, .modal-footer {
                display: none !important;
            }
        }
        /* สไตล์สำหรับ Loading Indicator */
        .loading-spinner {
            border-top-color: #3b82f6;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">
    
    <div class="max-w-6xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- คอลัมน์ซ้าย: ฟอร์มหลัก -->
        <div class="lg:col-span-2 bg-white shadow-xl rounded-xl p-6 md:p-10">
            <h1 class="text-3xl font-bold text-center text-indigo-700 mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                สร้างใบปะหน้าจัดส่งสินค้าอัตโนมัติ
            </h1>

            <!-- ส่วนจัดการฐานข้อมูลที่อยู่ (อัปโหลด CSV) -->
            <div class="mb-8 p-4 bg-yellow-50 rounded-lg border border-yellow-300">
                <h2 class="text-lg font-semibold text-yellow-800 mb-2 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    จัดการฐานข้อมูลที่อยู่
                </h2>
                <input type="file" id="csvFile" accept=".csv" class="w-full p-2 border border-yellow-400 rounded-lg bg-white" onchange="handleFileUpload(event)">
                <p id="dataStatus" class="mt-2 text-sm font-medium text-blue-600">สถานะ: กำลังโหลดฐานข้อมูล...</p>
                <p class="mt-2 text-xs text-gray-500">User ID (เพื่อการบันทึก): <span id="currentUserId">Loading...</span></p>
            </div>

            <form id="labelForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- ส่วนผู้ส่ง (Sender) -->
                <div class="p-6 bg-gray-50 rounded-lg border-2 border-dashed border-gray-300 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2 text-indigo-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                            </svg>
                        </span>
                        ข้อมูลผู้ส่ง (Sender)
                    </h2>
                    <input type="text" id="senderName" placeholder="ชื่อ-นามสกุล ผู้ส่ง" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                    <textarea id="senderAddress1" placeholder="ที่อยู่ (บ้านเลขที่, ถนน)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500"></textarea>
                    
                    <input type="text" id="senderZipcode" placeholder="รหัสไปรษณีย์ (เช่น 10200)" maxlength="5" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" oninput="lookupAddress('sender')">
                    
                    <div id="senderDistrictContainer" class="w-full">
                        <input type="text" id="senderDistrict" placeholder="แขวง/ตำบล" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>
                    
                    <input type="text" id="senderAmphoe" placeholder="เขต/อำเภอ" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    <input type="text" id="senderProvince" placeholder="จังหวัด" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    <input type="tel" id="senderPhone" placeholder="เบอร์โทรศัพท์ (ถ้ามี)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <!-- ส่วนผู้รับ (Recipient) -->
                <div class="p-6 bg-blue-50 rounded-lg border-2 border-dashed border-blue-300 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <span class="mr-2 text-blue-500">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.727A8 8 0 016.343 15.273L4 17.5V10h12a8 8 0 01.657 6.727z" />
                            </svg>
                        </span>
                        ข้อมูลผู้รับ (Recipient)
                    </h2 >
                    <input type="text" id="recipientName" placeholder="ชื่อ-นามสกุล ผู้รับ" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="recipientAddress1" placeholder="ที่อยู่ (บ้านเลขที่, ถนน)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>

                    <input type="text" id="recipientZipcode" placeholder="รหัสไปรษณีย์ (เช่น 96210)" maxlength="5" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" oninput="lookupAddress('recipient')">

                    <div id="recipientDistrictContainer" class="w-full">
                        <input type="text" id="recipientDistrict" placeholder="แขวง/ตำบล" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    </div>

                    <input type="text" id="recipientAmphoe" placeholder="เขต/อำเภอ" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    <input type="text" id="recipientProvince" placeholder="จังหวัด" required class="w-full p-3 border border-gray-300 rounded-lg bg-gray-100" readonly>
                    <input type="tel" id="recipientPhone" placeholder="เบอร์โทรศัพท์ (ต้องระบุ)" required class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- ปุ่มสร้างและบันทึก -->
                <div class="md:col-span-2 mt-6 flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                    <button type="submit" class="flex-1 px-8 py-3 bg-green-500 text-white font-bold rounded-xl shadow-lg hover:bg-green-600 transition duration-300 transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        สร้างใบปะหน้าและดูตัวอย่าง
                    </button>
                    <button type="button" onclick="saveLabelData()" class="flex-1 px-8 py-3 bg-indigo-500 text-white font-bold rounded-xl shadow-lg hover:bg-indigo-600 transition duration-300 transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-3-3v6M17 21H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        บันทึกรายการนี้
                    </button>
                </div>
            </form>
        </div>

        <!-- คอลัมน์ขวา: รายการที่บันทึก -->
        <div class="lg:col-span-1 bg-white shadow-xl rounded-xl p-6 md:p-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-teal-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 012-2h10a2 2 0 012 2v10a2 2 0 01-2 2H7a2 2 0 01-2-2V8zm0 0l2 2m0 0l2 2m-2-2h-3" />
                </svg>
                รายการใบปะหน้าที่บันทึก
            </h2>
            <div id="savedLabelsList" class="space-y-3">
                <p class="text-center text-gray-500">กำลังโหลดรายการ...</p>
            </div>
        </div>
    </div>

    <!-- Modal/Dialog สำหรับแสดงตัวอย่างใบปะหน้าก่อนพิมพ์ -->
    <div id="printModal" class="hidden fixed inset-0 z-50 overflow-y-auto bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl h-full md:h-5/6 flex flex-col">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-xl font-bold text-indigo-700">ตัวอย่างใบปะหน้าห่อสินค้า (Shipping Label Preview)</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            
            <!-- พื้นที่แสดงใบปะหน้า/พื้นที่สั่งพิมพ์ -->
            <div id="print-area-container" class="flex-grow overflow-y-auto p-4 md:p-8 bg-gray-100 flex justify-center items-start">
                <div id="print-area" class="w-full max-w-2xl bg-white p-6 md:p-8 shadow-lg border border-gray-300 min-h-[300px]">
                    <!-- เนื้อหาใบปะหน้าจะถูกสร้างที่นี่ด้วย JavaScript -->
                </div>
            </div>

            <!-- ปุ่มสั่งพิมพ์/ดาวน์โหลด PDF -->
            <div class="modal-footer p-4 border-t bg-gray-50 flex flex-col md:flex-row justify-center space-y-2 md:space-y-0 md:space-x-4">
                <button onclick="printOrDownloadPdf('print')" class="px-6 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition duration-150 shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                      <path fill-rule="evenodd" d="M5 4v3H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V9a2 2 0 00-2-2h-1V4a2 2 0 00-2-2H7a2 2 0 00-2 2zm12 3h-2v4H5V7H4V4h12v3z" clip-rule="evenodd" />
                    </svg>
                    พิมพ์ (Print Dialog)
                </button>
                <button id="downloadPdfButton" onclick="printOrDownloadPdf('download')" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414zM10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg>
                    ดาวน์โหลด PDF (A6)
                </button>
            </div>
        </div>
    </div>

    <!-- Custom Message Box for errors -->
    <div id="messageBox" class="hidden fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-0" role="alert">
        <p id="messageText"></p>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, addDoc, onSnapshot, collection, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- 1. CONFIGURATION & GLOBAL VARIABLES ---
        const DEFAULT_CSV_URL = "https://raw.githubusercontent.com/OSX-L1/Express/refs/heads/main/data/thailand-zipcodes.csv"; 
        const CACHE_KEY = 'thai_zipcode_db_v3'; 
        let ADDRESS_DB = {};

        // Firebase instances
        let db, auth, userId, appId;
        const form = document.getElementById('labelForm');
        const printModal = document.getElementById('printModal');
        const printArea = document.getElementById('print-area');
        const dataStatusElement = document.getElementById('dataStatus');

        // Firestore Setup
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- 2. FIREBASE INITIALIZATION AND AUTHENTICATION ---
        async function initializeFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Sign in with custom token if available, otherwise sign in anonymously
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                // Once authenticated, set the user ID and start listening for data
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('currentUserId').textContent = userId;
                        // Start real-time listener for saved labels
                        setupRealtimeListener();
                    } else {
                        // This case should ideally not happen in the Canvas environment
                        console.error("User not authenticated.");
                        document.getElementById('currentUserId').textContent = "Authentication Failed";
                    }
                });

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                showMessage("ไม่สามารถเชื่อมต่อฐานข้อมูลได้: " + error.message, 'error');
            }
        }
        
        // --- 3. FIRESTORE DATA HANDLING (SAVE & LOAD) ---
        function getCollectionPath() {
            if (!userId) {
                throw new Error("User not authenticated.");
            }
            // Path: /artifacts/{appId}/users/{userId}/shipping_labels
            return `artifacts/${appId}/users/${userId}/shipping_labels`;
        }
        
        // Global function to be called from the Save button (must be defined in window scope)
        window.saveLabelData = async function() {
            if (!userId) {
                showMessage("กรุณารอการเชื่อมต่อฐานข้อมูลให้เสร็จสิ้นก่อน", 'error');
                return;
            }
            
            // ใช้ฟังก์ชัน getFormData เพื่อดึงข้อมูลที่สมบูรณ์
            const data = getFormData();

            // ตรวจสอบความถูกต้องของข้อมูล (อย่างน้อยต้องมีชื่อผู้รับ/ผู้ส่ง)
            if (!data.recipient.name || !data.sender.name) {
                showMessage("กรุณากรอกชื่อผู้ส่งและผู้รับให้ครบถ้วนก่อนบันทึก", 'error');
                return;
            }

            try {
                const docRef = await addDoc(collection(db, getCollectionPath()), {
                    ...data,
                    createdAt: new Date(),
                });
                showMessage("บันทึกรายการใบปะหน้าสำเร็จ!", 'success');
                console.log("Document written with ID: ", docRef.id);
            } catch (e) {
                console.error("Error adding document: ", e);
                showMessage("เกิดข้อผิดพลาดในการบันทึกข้อมูล: " + e.message, 'error');
            }
        }
        
        async function deleteLabel(docId) {
            if (!userId) return;
            try {
                // ใช้ custom modal แทน window.confirm
                if (!await showCustomConfirmation("ยืนยันการลบ", "คุณแน่ใจหรือไม่ที่จะลบรายการนี้?")) return;

                await deleteDoc(doc(db, getCollectionPath(), docId));
                showMessage("ลบรายการสำเร็จแล้ว", 'info');
            } catch (e) {
                console.error("Error deleting document: ", e);
                showMessage("เกิดข้อผิดพลาดในการลบข้อมูล: " + e.message, 'error');
            }
        }
        
        // Setup real-time listener for saved labels
        function setupRealtimeListener() {
            const q = query(collection(db, getCollectionPath()));
            onSnapshot(q, (querySnapshot) => {
                const labels = [];
                querySnapshot.forEach((doc) => {
                    labels.push({ id: doc.id, ...doc.data() });
                });
                renderSavedLabels(labels.sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate()));
            }, (error) => {
                console.error("Error listening to Firestore:", error);
                document.getElementById('savedLabelsList').innerHTML = `<p class="text-red-500">เกิดข้อผิดพลาดในการโหลดรายการที่บันทึก: ${error.message}</p>`;
            });
        }
        
        function renderSavedLabels(labels) {
            const listContainer = document.getElementById('savedLabelsList');
            if (labels.length === 0) {
                listContainer.innerHTML = '<p class="text-center text-gray-500 p-4 border rounded-lg bg-gray-50">ยังไม่มีรายการที่ถูกบันทึกไว้</p>';
                return;
            }

            listContainer.innerHTML = labels.map(label => {
                const date = label.createdAt ? label.createdAt.toDate().toLocaleDateString('th-TH') : 'N/A';
                return `
                    <div class="p-3 border border-teal-300 rounded-lg shadow-sm bg-teal-50 hover:bg-teal-100 transition duration-150 flex justify-between items-center space-x-2">
                        <div>
                            <p class="font-bold text-teal-800 truncate">${label.recipient.name}</p>
                            <p class="text-xs text-gray-600">${label.recipient.province} | ${label.recipient.zipcode}</p>
                            <p class="text-xs text-gray-500 mt-1">บันทึกเมื่อ: ${date}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="window.loadLabelToForm('${label.id}')" class="p-2 text-white bg-blue-500 rounded-full hover:bg-blue-600 focus:outline-none" title="โหลดลงฟอร์ม">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                </svg>
                            </button>
                            <button onclick="window.deleteLabel('${label.id}')" class="p-2 text-white bg-red-500 rounded-full hover:bg-red-600 focus:outline-none" title="ลบรายการ">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Global function to load saved data into the form
        window.loadLabelToForm = function(docId) {
            const label = document.getElementById('savedLabelsList').querySelector(`[onclick="window.loadLabelToForm('${docId}')"]`).closest('div');
            
            // Find the data object from the snapshot list (a bit tricky, but we can do it via Firestore listener data)
            // Since we don't store the full list globally, we must refetch the list from Firestore's cache or structure the data better.
            // For simplicity in this single-file context, we rely on the realtime data array (if we fetched it) or just trust the user will see the data changes.
            // A better way is to attach the data to the DOM element or maintain a global array. Let's maintain a global array.
            
            // Since we don't have the labels array outside of renderSavedLabels scope in this setup, 
            // the simplest way is to manually reconstruct the data from the list or, better, rely on the onSnapshot cache. 
            // For now, let's just make sure the user sees a confirmation and reload the data logic.
            
            // Re-query the Firestore cache for the specific document
            onSnapshot(doc(db, getCollectionPath(), docId), (docSnapshot) => {
                if (docSnapshot.exists()) {
                    const data = docSnapshot.data();
                    
                    // Sender
                    document.getElementById('senderName').value = data.sender.name || '';
                    document.getElementById('senderAddress1').value = data.sender.address1 || '';
                    document.getElementById('senderZipcode').value = data.sender.zipcode || '';
                    document.getElementById('senderPhone').value = data.sender.phone || '';
                    
                    // Recipient
                    document.getElementById('recipientName').value = data.recipient.name || '';
                    document.getElementById('recipientAddress1').value = data.recipient.address1 || '';
                    document.getElementById('recipientZipcode').value = data.recipient.zipcode || '';
                    document.getElementById('recipientPhone').value = data.recipient.phone || '';

                    // For the address parts, we set the values and trigger lookupAddress manually
                    // to recreate the required dropdown/input structure.
                    
                    // Step 1: Set Zipcodes
                    lookupAddress('sender'); // This will trigger the lookup based on the zipcode value already set
                    lookupAddress('recipient');

                    // Step 2: Manually set the rest of the address fields 
                    // (Note: If the zip code is found in DB, the lookupAddress will try to create a select. 
                    // If it finds multiple, the user still needs to select from the dropdown for full accuracy).

                    // Force manual setting of text fields for display (even if a select is present)
                    document.getElementById('senderAmphoe').value = data.sender.amphoe || '';
                    document.getElementById('senderProvince').value = data.sender.province || '';
                    document.getElementById('recipientAmphoe').value = data.recipient.amphoe || '';
                    document.getElementById('recipientProvince').value = data.recipient.province || '';
                    
                    // If lookupAddress created a simple input for district, set its value
                    const senderDistrictInput = document.getElementById('senderDistrict');
                    if (senderDistrictInput && senderDistrictInput.tagName.toLowerCase() === 'input') {
                        senderDistrictInput.value = data.sender.district || '';
                    }

                    const recipientDistrictInput = document.getElementById('recipientDistrict');
                    if (recipientDistrictInput && recipientDistrictInput.tagName.toLowerCase() === 'input') {
                        recipientDistrictInput.value = data.recipient.district || '';
                    }
                    
                    showMessage(`โหลดรายการ "${data.recipient.name}" ลงในฟอร์มสำเร็จ`, 'success');
                    
                } else {
                    showMessage("ไม่พบข้อมูลรายการที่บันทึก", 'error');
                }
            }, (error) => {
                console.error("Error loading document:", error);
                showMessage("ไม่สามารถโหลดข้อมูลรายการที่บันทึกได้", 'error');
            });
        }
        
        // --- 4. CORE ADDRESS LOGIC (Unchanged but moved to global scope) ---

        // ฟังก์ชันแสดงข้อความแจ้งเตือนแทน alert()
        window.showMessage = function(text, type = 'error') {
            const box = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            
            box.className = 'hidden fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-0';
            
            let bgColor = 'bg-red-500'; 
            if (type === 'success') {
                bgColor = 'bg-green-500';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
            }

            box.classList.remove('hidden');
            box.classList.add(bgColor, 'opacity-100');
            messageText.textContent = text;

            setTimeout(() => {
                box.classList.remove('opacity-100');
                box.classList.add('opacity-0');
                setTimeout(() => box.classList.add('hidden'), 300);
            }, 3000);
        }

        // Custom Confirmation Modal (to replace window.confirm)
        function showCustomConfirmation(title, message) {
            return new Promise(resolve => {
                const modalHtml = `
                    <div id="confirmModal" class="fixed inset-0 bg-gray-900 bg-opacity-75 z-[60] flex items-center justify-center p-4">
                        <div class="bg-white rounded-lg shadow-2xl p-6 w-full max-w-sm">
                            <h4 class="text-xl font-bold text-red-600 mb-4">${title}</h4>
                            <p class="text-gray-700 mb-6">${message}</p>
                            <div class="flex justify-end space-x-3">
                                <button id="cancelConfirm" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300 transition">ยกเลิก</button>
                                <button id="okConfirm" class="px-4 py-2 text-white bg-red-500 rounded-lg hover:bg-red-600 transition">ยืนยัน</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                const modal = document.getElementById('confirmModal');
                
                document.getElementById('okConfirm').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                
                document.getElementById('cancelConfirm').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });
        }
        
        // (Other address functions: fetchAndCacheData, parseCSV, selectAddress, lookupAddress) are assumed to be defined globally 
        // or will be redefined below to ensure scope compatibility

        // ฟังก์ชันดึงข้อมูลจาก URL และแคช
        async function fetchAndCacheData() {
            // โค้ดเดิมสำหรับโหลดและแคชข้อมูลรหัสไปรษณีย์
            // ... (โค้ดเดิม) ...
            const cachedData = localStorage.getItem(CACHE_KEY);
            if (cachedData) {
                try {
                    ADDRESS_DB = JSON.parse(cachedData);
                    const count = Object.keys(ADDRESS_DB).length.toLocaleString();
                    dataStatusElement.textContent = `สถานะ: โหลดฐานข้อมูลสำเร็จ (${count} รหัสไปรษณีย์) - (จาก LocalStorage)`;
                    dataStatusElement.classList.remove('text-red-500', 'text-yellow-700');
                    dataStatusElement.classList.add('text-blue-600');
                    return;
                } catch (e) {
                    console.error("Error parsing cached data:", e);
                    localStorage.removeItem(CACHE_KEY);
                }
            }

            dataStatusElement.textContent = `สถานะ: กำลังโหลดฐานข้อมูลที่อยู่จาก GitHub...`;
            dataStatusElement.classList.remove('text-green-600', 'text-blue-600');
            dataStatusElement.classList.add('text-yellow-700');

            try {
                const response = await fetch(DEFAULT_CSV_URL);
                if (!response.ok) throw new Error(`HTTP error! สถานะ: ${response.status}`);
                
                const csvText = await response.text();
                const newDB = parseCSV(csvText);

                if (Object.keys(newDB).length > 0) {
                    ADDRESS_DB = newDB;
                    localStorage.setItem(CACHE_KEY, JSON.stringify(ADDRESS_DB)); 
                    const count = Object.keys(ADDRESS_DB).length.toLocaleString();
                    dataStatusElement.textContent = `สถานะ: โหลดฐานข้อมูลสำเร็จ (${count} รหัสไปรษณีย์) - (ใหม่จาก URL)`;
                    dataStatusElement.classList.remove('text-yellow-700', 'text-blue-600');
                    dataStatusElement.classList.add('text-green-600');
                } else {
                    throw new Error("CSV file parsed but contained no valid data.");
                }

            } catch (error) {
                console.error("Error fetching or parsing CSV:", error);
                dataStatusElement.textContent = `สถานะ: โหลดฐานข้อมูลล้มเหลว (ไม่สามารถเข้าถึง URL หรือรูปแบบไม่ถูกต้อง) - ${error.message}`;
                dataStatusElement.classList.remove('text-yellow-700', 'text-green-600', 'text-blue-600');
                dataStatusElement.classList.add('text-red-500');
            }
        }
        
        window.handleFileUpload = function(event) {
            // โค้ดเดิมสำหรับจัดการการอัปโหลด CSV
            // ... (โค้ดเดิม) ...
            const file = event.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.csv')) {
                showMessage("ไฟล์ที่อัปโหลดไม่ใช่ไฟล์ CSV", 'error');
                dataStatusElement.textContent = "สถานะ: การโหลดล้มเหลว (ไฟล์ต้องเป็น CSV)";
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const newDB = parseCSV(text);
                
                if (Object.keys(newDB).length > 0) {
                    ADDRESS_DB = newDB; 
                    localStorage.setItem(CACHE_KEY, JSON.stringify(ADDRESS_DB));
                    const count = Object.keys(ADDRESS_DB).length.toLocaleString();
                    dataStatusElement.textContent = `สถานะ: โหลดฐานข้อมูลสำเร็จ (${count} รหัสไปรษณีย์) - (จากไฟล์ที่อัปโหลด)`;
                    dataStatusElement.classList.remove('text-red-500', 'text-blue-600');
                    dataStatusElement.classList.add('text-green-600');
                    showMessage("โหลดฐานข้อมูลรหัสไปรษณีย์ใหม่จากไฟล์สำเร็จแล้ว!", 'success');
                } else {
                    showMessage("ไม่สามารถอ่านข้อมูลที่อยู่จากไฟล์ CSV นี้ได้ (โปรดตรวจสอบรูปแบบ)", 'error');
                    dataStatusElement.textContent = `สถานะ: การโหลดล้มเหลว (รูปแบบ CSV อาจไม่ถูกต้อง - ข้อมูลปัจจุบัน ${Object.keys(ADDRESS_DB).length.toLocaleString()} รหัสไปรษณีย์)`;
                    dataStatusElement.classList.remove('text-green-600', 'text-blue-600');
                    dataStatusElement.classList.add('text-red-500');
                }
            };
            reader.readAsText(file, 'UTF-8'); 
        }

        window.parseCSV = function(csvText) {
            // โค้ดเดิมสำหรับแยกวิเคราะห์ CSV
            // ... (โค้ดเดิม) ...
            const lines = csvText.split('\n');
            const db = {};
            for (let i = 1; i < lines.length; i++) { 
                const line = lines[i].trim();
                if (line === "") continue;

                const columns = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/); 
                
                if (!columns || columns.length < 4) continue;
                
                const clean = (str) => str ? str.trim().replace(/^"|"$/g, '') : '';

                const province = clean(columns[0]);
                const amphoe = clean(columns[1]); 
                const district = clean(columns[2]); 
                const zipcode = clean(columns[3]); 
                
                if (zipcode.length === 5 && !isNaN(zipcode) && province && amphoe && district) {
                    const address = { district, amphoe, province };
                    
                    if (!db[zipcode]) {
                        db[zipcode] = [];
                    }
                    if (!db[zipcode].some(item => 
                        item.district === address.district && 
                        item.amphoe === address.amphoe && 
                        item.province === address.province
                    )) {
                        db[zipcode].push(address); 
                    }
                }
            }
            return db;
        }
        
        window.selectAddress = function(prefix) {
            // โค้ดเดิมสำหรับเลือกที่อยู่จาก Dropdown
            // ... (โค้ดเดิม) ...
            const selectElement = document.getElementById(`${prefix}DistrictSelect`);
            const selectedIndex = selectElement.value;
            
            const zipcode = document.getElementById(`${prefix}Zipcode`).value.trim();
            const addressList = ADDRESS_DB[zipcode];
            
            const districtInput = document.getElementById(`${prefix}District`);
            const amphoeElement = document.getElementById(`${prefix}Amphoe`);
            const provinceElement = document.getElementById(`${prefix}Province`);
            
            if (selectedIndex !== "" && addressList && addressList[parseInt(selectedIndex)]) {
                const selectedAddress = addressList[parseInt(selectedIndex)];
                
                districtInput.value = selectedAddress.district; 
                amphoeElement.value = selectedAddress.amphoe;
                provinceElement.value = selectedAddress.province;
            } else {
                districtInput.value = '';
                amphoeElement.value = '';
                provinceElement.value = '';
            }
        }

        window.lookupAddress = function(prefix) {
            // โค้ดเดิมสำหรับดึงข้อมูลที่อยู่จากรหัสไปรษณีย์
            // ... (โค้ดเดิม) ...
            const zipcode = document.getElementById(`${prefix}Zipcode`).value.trim();
            const districtContainer = document.getElementById(`${prefix}DistrictContainer`);
            
            const amphoeElement = document.getElementById(`${prefix}Amphoe`);
            const provinceElement = document.getElementById(`${prefix}Province`);
            
            const districtInput = document.getElementById(`${prefix}District`);
            if (districtInput) districtInput.value = ''; 
            amphoeElement.value = '';
            provinceElement.value = '';

            amphoeElement.classList.add('bg-gray-100');
            amphoeElement.classList.remove('bg-white');
            provinceElement.classList.add('bg-gray-100');
            provinceElement.classList.remove('bg-white');


            if (zipcode.length === 5 && ADDRESS_DB[zipcode]) {
                const results = ADDRESS_DB[zipcode];
                
                let selectHtml = `
                    <select id="${prefix}DistrictSelect" onchange="selectAddress('${prefix}')" required 
                            class="w-full p-3 border border-indigo-500 rounded-lg bg-white focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>--- กรุณาเลือกแขวง/ตำบลที่ถูกต้อง ---</option>
                `;
                
                results.forEach((addr, index) => {
                    selectHtml += `<option value="${index}">${addr.district} (${addr.amphoe})</option>`;
                });
                
                selectHtml += `</select>`;
                
                districtContainer.innerHTML = selectHtml;
                districtContainer.innerHTML += `<input type="hidden" id="${prefix}District" name="${prefix}District" required>`;

                if (results.length === 1) {
                    document.getElementById(`${prefix}DistrictSelect`).value = 0;
                    selectAddress(prefix);
                    document.getElementById(`${prefix}DistrictSelect`).disabled = true; 
                    showMessage("พบข้อมูลที่อยู่เดียว: เติมข้อมูลอัตโนมัติ", 'success');
                } else {
                    document.getElementById(`${prefix}DistrictSelect`).disabled = false;
                    showMessage("พบหลายตำบลในรหัสไปรษณีย์นี้: กรุณาเลือกจาก Dropdown", 'info');
                }

            } else {
                districtContainer.innerHTML = `
                    <input type="text" id="${prefix}District" placeholder="แขวง/ตำบล" required 
                            class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-red-500 focus:border-red-500">
                `;
                amphoeElement.classList.remove('bg-gray-100');
                amphoeElement.classList.add('bg-white');
                provinceElement.classList.remove('bg-gray-100');
                provinceElement.classList.add('bg-white');
                
                if (zipcode.length === 5) {
                    showMessage("ไม่พบรหัสไปรษณีย์นี้ในฐานข้อมูล: กรุณากรอกข้อมูลที่อยู่ด้วยตนเอง", 'error');
                }
            }
        }
        
        // --- 5. PDF DOWNLOAD AND PRINTING ---
        
        // ฟังก์ชันดึงข้อมูลฟอร์ม
        function getFormData() {
             const getVal = (id) => document.getElementById(id)?.value || '';
             
             return {
                sender: {
                    name: getVal('senderName'),
                    address1: getVal('senderAddress1'),
                    district: getVal('senderDistrict'),
                    amphoe: getVal('senderAmphoe'),
                    province: getVal('senderProvince'),
                    zipcode: getVal('senderZipcode'),
                    phone: getVal('senderPhone'),
                },
                recipient: {
                    name: getVal('recipientName'),
                    address1: getVal('recipientAddress1'),
                    district: getVal('recipientDistrict'),
                    amphoe: getVal('recipientAmphoe'),
                    province: getVal('recipientProvince'),
                    zipcode: getVal('recipientZipcode'),
                    phone: getVal('recipientPhone'),
                }
            };
        }

        function generateLabelHtml(data) {
             const sender = data.sender;
             const recipient = data.recipient;
             const today = new Date().toLocaleDateString('th-TH', { dateStyle: 'short' });
             
             // สร้าง HTML สำหรับใบปะหน้า
             return `
                 <div class="border-4 border-black p-4 md:p-6 w-full h-full text-sm">
                     <div class="flex justify-between items-start border-b border-black pb-2 mb-4">
                         <h1 class="text-xl font-bold text-black uppercase">ใบปะหน้าสำหรับจัดส่ง</h1>
                         <span class="text-xs">วันที่: ${today}</span>
                     </div>
 
                     <!-- ส่วนผู้ส่ง (Sender) -->
                     <div class="border-b border-black pb-4 mb-4">
                         <p class="text-lg font-bold text-indigo-700 mb-1">ผู้ส่ง (Sender):</p>
                         <p class="font-bold">${sender.name} (โทร: ${sender.phone || '-'})</p>
                         <p>${sender.address1}</p>
                         <p>ต.${sender.district} อ.${sender.amphoe} จ.${sender.province} ${sender.zipcode}</p>
                     </div>
 
                     <!-- ส่วนผู้รับ (Recipient) - เน้นตัวใหญ่พิเศษ -->
                     <div class="border-b border-black pb-4 mb-4">
                         <p class="text-lg font-bold text-blue-700 mb-2">ผู้รับ (Recipient):</p>
                         <div class="p-3 border-2 border-red-500 bg-red-50 rounded-lg">
                             <h3 class="text-2xl font-extrabold text-red-800">${recipient.name}</h3>
                             <p class="text-xl font-bold mt-1">โทร: ${recipient.phone}</p>
                             <p class="mt-2 text-lg">${recipient.address1}</p>
                             <p class="text-lg font-bold">ต.${recipient.district} อ.${recipient.amphoe} จ.${recipient.province} <span class="text-3xl font-extrabold ml-4">${recipient.zipcode}</span></p>
                         </div>
                     </div>
 
                     <!-- พื้นที่หมายเหตุ/ข้อมูลการจัดส่ง -->
                     <div class="pt-2">
                         <p class="text-sm font-semibold mb-1">หมายเหตุ/ประเภทการจัดส่ง:</p>
                         <div class="h-16 border border-gray-400 p-2 rounded">
                             <!-- ช่องว่างสำหรับเขียนหมายเหตุเพิ่มเติม -->
                         </div>
                     </div>
                 </div>
             `;
        }
        
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            const data = getFormData();
            
            if (!data.sender.district || !data.recipient.district) {
                showMessage("กรุณากรอกหรือเลือก ตำบล/แขวง ให้ครบถ้วนทั้งผู้ส่งและผู้รับ", 'error');
                return;
            }

            // 1. สร้าง HTML และใส่เข้าไปในพื้นที่พิมพ์
            printArea.innerHTML = generateLabelHtml(data);

            // 2. เปิด Modal
            printModal.classList.remove('hidden');
            printModal.classList.add('flex');
        });
        
        window.printOrDownloadPdf = async function(action) {
            const downloadButton = document.getElementById('downloadPdfButton');
            
            if (action === 'print') {
                // ตัวเลือกที่ 1: ใช้ Window Print Dialog ธรรมดา
                const modalContainer = document.querySelector('#printModal > div');
                if (modalContainer) modalContainer.style.display = 'none';
                
                window.print();
                
                if (modalContainer) modalContainer.style.display = 'flex';
                showMessage("กำลังเปิดหน้าต่างพิมพ์. คุณสามารถเลือก 'Save as PDF' ได้", 'info');
                return;
            }
            
            // ตัวเลือกที่ 2: ดาวน์โหลดเป็น PDF โดยตรง (ใช้ html2canvas + jspdf)
            downloadButton.disabled = true;
            downloadButton.innerHTML = `<span class="loading-spinner border-4 border-gray-300 border-t-4 border-indigo-500 h-5 w-5 rounded-full mr-2"></span> กำลังสร้าง PDF...`;

            try {
                // Ensure printArea uses a white background for PDF conversion
                printArea.style.backgroundColor = 'white';

                const canvas = await html2canvas(printArea, { 
                    scale: 2, // เพิ่ม scale เพื่อให้ภาพคมชัดขึ้น
                    logging: false 
                });
                
                const imgData = canvas.toDataURL('image/png');
                
                // กำหนดขนาด PDF เป็น A6 (105mm x 148mm) ซึ่งเป็นขนาดที่เหมาะกับใบปะหน้า
                const pdf = new window.jspdf.jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: 'a6'
                });

                // คำนวณอัตราส่วนภาพเพื่อให้พอดีกับขนาด A6
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgHeight = canvas.height * pdfWidth / canvas.width;

                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, imgHeight);
                
                // ตั้งชื่อไฟล์
                const recipientName = getFormData().recipient.name || 'Shipping_Label';
                pdf.save(`${recipientName}_${new Date().toISOString().slice(0, 10)}.pdf`);
                
                showMessage("ดาวน์โหลดใบปะหน้าเป็น PDF สำเร็จ", 'success');

            } catch (error) {
                console.error("PDF Download Error:", error);
                showMessage("เกิดข้อผิดพลาดในการสร้างไฟล์ PDF", 'error');
            } finally {
                downloadButton.disabled = false;
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414zM10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                    </svg> ดาวน์โหลด PDF (A6)`;
            }
        }
        
        window.closeModal = function() {
            printModal.classList.add('hidden');
            printModal.classList.remove('flex');
            printArea.innerHTML = ''; 
        }

        // --- 6. INITIALIZATION CALLS ---
        window.onload = function() {
            // 1. โหลดฐานข้อมูลรหัสไปรษณีย์
            fetchAndCacheData(); 
            // 2. เริ่มต้น Firebase และการยืนยันตัวตน
            initializeFirebase(); 
        };
    </script>
</body>
</html>
