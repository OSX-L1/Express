<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</title>
    <!-- ‡πÇ‡∏´‡∏•‡∏î Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun -->
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <!-- ‡πÇ‡∏´‡∏•‡∏î External Libraries: Firebase, html2canvas, jspdf -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js" type="module"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏ü‡∏≠‡∏ô‡∏ï‡πå Sarabun ‡∏ó‡∏±‡πà‡∏ß‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô */
        body {
            font-family: 'Sarabun', sans-serif;
            background-color: #f7f9fb;
        }
        /* ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤ */
        .shipping-label {
            width: 80mm; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì 8x10 ‡∏ã‡∏°. ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡πá‡∏Å */
            height: 100mm;
            padding: 10mm;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            background-color: white;
            font-size: 10pt;
            line-height: 1.3;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8">
        <!-- ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° (Control Panel) -->
        <div class="lg:w-1/2 w-full bg-white p-6 rounded-xl shadow-lg h-full">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 border-b pb-2">üì¶ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏™‡πà‡∏á‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
            
            <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ -->
            <div id="message-box" class="hidden p-3 mb-4 rounded-lg text-sm transition-all duration-300"></div>

            <div id="app-content">
                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (Sender Info) -->
                <h2 class="text-xl font-semibold text-indigo-700 mt-4 mb-3">üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (Sender)</h2>
                <form id="sender-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="sender_name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•/‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤</label>
                        <input type="text" id="sender_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á">
                    </div>
                    <div>
                        <label for="sender_phone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="sender_phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="081-123-4567">
                    </div>
                    <div class="md:col-span-2">
                        <label for="sender_address" class="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                        <textarea id="sender_address" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">123/45 ‡∏ñ‡∏ô‡∏ô‡∏™‡∏≤‡∏ò‡∏∏‡∏õ‡∏£‡∏∞‡∏î‡∏¥‡∏©‡∏ê‡πå</textarea>
                    </div>
                    <div>
                        <label for="sender_province" class="block text-sm font-medium text-gray-700">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                        <input type="text" id="sender_province" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£">
                    </div>
                    <div>
                        <label for="sender_district" class="block text-sm font-medium text-gray-700">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï</label>
                        <input type="text" id="sender_district" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ö‡∏≤‡∏á‡∏Ñ‡∏≠‡πÅ‡∏´‡∏•‡∏°">
                    </div>
                    <div>
                        <label for="sender_subdistrict" class="block text-sm font-medium text-gray-700">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á</label>
                        <input type="text" id="sender_subdistrict" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ö‡∏≤‡∏á‡πÇ‡∏Ñ‡∏•‡πà">
                    </div>
                    <div>
                        <label for="sender_zipcode" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                        <input type="text" id="sender_zipcode" maxlength="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="10120">
                    </div>
                </form>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (Recipient Info) -->
                <h2 class="text-xl font-semibold text-indigo-700 mt-6 mb-3">üë§ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (Recipient)</h2>
                <form id="recipient-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="recipient_name" class="block text-sm font-medium text-gray-700">‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                        <input type="text" id="recipient_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö ‡∏ó‡∏î‡∏™‡∏≠‡∏ö">
                    </div>
                    <div>
                        <label for="recipient_phone" class="block text-sm font-medium text-gray-700">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</label>
                        <input type="tel" id="recipient_phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="098-765-4321">
                    </div>
                    <div class="md:col-span-2">
                        <label for="recipient_address" class="block text-sm font-medium text-gray-700">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</label>
                        <textarea id="recipient_address" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border">20/1 ‡∏´‡∏°‡∏π‡πà 5 ‡∏ï‡∏≥‡∏ö‡∏•‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠</textarea>
                    </div>
                    <div>
                        <label for="recipient_province" class="block text-sm font-medium text-gray-700">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</label>
                        <input type="text" id="recipient_province" oninput="handleAddressInput('recipient')" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä">
                    </div>
                    <div>
                        <label for="recipient_district" class="block text-sm font-medium text-gray-700">‡∏≠‡∏≥‡πÄ‡∏†‡∏≠/‡πÄ‡∏Ç‡∏ï</label>
                        <input type="text" id="recipient_district" oninput="handleAddressInput('recipient')" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ó‡πà‡∏≤‡∏®‡∏≤‡∏•‡∏≤">
                    </div>
                    <div>
                        <label for="recipient_subdistrict" class="block text-sm font-medium text-gray-700">‡∏ï‡∏≥‡∏ö‡∏•/‡πÅ‡∏Ç‡∏ß‡∏á</label>
                        <input type="text" id="recipient_subdistrict" oninput="handleAddressInput('recipient')" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="‡∏ó‡πà‡∏≤‡πÄ‡∏£‡∏∑‡∏≠">
                    </div>
                    <div>
                        <label for="recipient_zipcode" class="block text-sm font-medium text-gray-700">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå</label>
                        <input type="text" id="recipient_zipcode" maxlength="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="80160">
                    </div>
                </form>

                <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏∑‡πà‡∏ô‡πÜ -->
                <h2 class="text-xl font-semibold text-indigo-700 mt-6 mb-3">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏±‡∏™‡∏î‡∏∏</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="tracking_number" class="block text-sm font-medium text-gray-700">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ (Tracking No.)</label>
                        <input type="text" id="tracking_number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="TH0123456789">
                    </div>
                    <div>
                        <label for="cod_amount" class="block text-sm font-medium text-gray-700">‡∏¢‡∏≠‡∏î‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á (COD)</label>
                        <input type="number" id="cod_amount" min="0" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2 border" value="0">
                    </div>
                </div>

                <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
                <div class="mt-8 pt-4 border-t flex flex-col md:flex-row gap-4">
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå -->
                    <button id="importZipCodeButton" onclick="importZipCodeData()" class="flex items-center justify-center w-full md:w-1/2 px-4 py-2 font-bold text-white bg-green-600 rounded-lg shadow-md hover:bg-green-700 disabled:opacity-50 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3.293 8.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L7 7.414V14a1 1 0 11-2 0V7.414L3.707 8.707a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                        </svg>
                        ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå
                    </button>
                    <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF -->
                    <button id="downloadPdfButton" onclick="downloadLabelPdf()" class="flex items-center justify-center w-full md:w-1/2 px-4 py-2 font-bold text-white bg-indigo-600 rounded-lg shadow-md hover:bg-indigo-700 disabled:opacity-50 transition duration-150">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414zM10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF
                    </button>
                </div>
            </div>
        </div>
        
        <!-- ‡∏™‡πà‡∏ß‡∏ô‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (Label Preview) -->
        <div class="lg:w-1/2 w-full flex justify-center items-start lg:pt-6">
            <div id="label-container" class="transform scale-90 lg:scale-100 origin-top-left" style="width: 80mm;">
                <!-- ‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡πÉ‡∏ô‡∏ô‡∏µ‡πâ -->
                <div id="shipping-label-preview" class="shipping-label border border-gray-300 rounded-md">
                    <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏î‡∏¢‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderLabel -->
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Setup ---
        setLogLevel('error');
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId;

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // Authentication
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("Firebase signed in. User ID:", userId);
                    await loadFormData();
                    renderLabel();
                } else {
                    console.log("Firebase signing in anonymously...");
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        }

        // --- Global Data and Utility Functions ---
        window.zipCodeData = []; // Array to hold all zip code objects
        window.zipCodeLookup = new Map(); // Map for fast lookup (Key: province|district|subdistrict -> Value: zipcode)

        window.showMessage = (message, type = 'info') => {
            const box = document.getElementById('message-box');
            box.textContent = message;
            box.className = 'p-3 mb-4 rounded-lg text-sm transition-all duration-300'; // Reset classes
            box.classList.remove('hidden');
            
            if (type === 'success') {
                box.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                box.classList.add('bg-red-100', 'text-red-800');
            } else {
                box.classList.add('bg-blue-100', 'text-blue-800');
            }

            // Hide after 5 seconds
            setTimeout(() => {
                box.classList.add('hidden');
            }, 5000);
        };
        
        // --- Form Data Handling ---

        window.getFormData = () => {
            return {
                sender: {
                    name: document.getElementById('sender_name')?.value || '',
                    phone: document.getElementById('sender_phone')?.value || '',
                    address: document.getElementById('sender_address')?.value || '',
                    province: document.getElementById('sender_province')?.value || '',
                    district: document.getElementById('sender_district')?.value || '',
                    subdistrict: document.getElementById('sender_subdistrict')?.value || '',
                    zipcode: document.getElementById('sender_zipcode')?.value || '',
                },
                recipient: {
                    name: document.getElementById('recipient_name')?.value || '',
                    phone: document.getElementById('recipient_phone')?.value || '',
                    address: document.getElementById('recipient_address')?.value || '',
                    province: document.getElementById('recipient_province')?.value || '',
                    district: document.getElementById('recipient_district')?.value || '',
                    subdistrict: document.getElementById('recipient_subdistrict')?.value || '',
                    zipcode: document.getElementById('recipient_zipcode')?.value || '',
                },
                package: {
                    tracking_number: document.getElementById('tracking_number')?.value || '',
                    cod_amount: document.getElementById('cod_amount')?.value || 0,
                }
            };
        };

        const formInputs = document.querySelectorAll('#sender-form input, #sender-form textarea, #recipient-form input, #recipient-form textarea');
        formInputs.forEach(input => {
            input.addEventListener('input', () => {
                renderLabel();
                saveFormData();
            });
        });

        // Save data to Firestore
        async function saveFormData() {
            if (!db || !userId) return;
            try {
                const data = getFormData();
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data`, 'shipping_label_form');
                await setDoc(userDocRef, data, { merge: true });
                console.log("Form data saved to Firestore.");
            } catch (error) {
                console.error("Error saving form data:", error);
            }
        }

        // Load data from Firestore
        async function loadFormData() {
            if (!db || !userId) return;
            try {
                const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/data`, 'shipping_label_form');
                const docSnap = await getDoc(userDocRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Form data loaded from Firestore:", data);
                    
                    // Apply loaded data to form fields
                    ['sender', 'recipient'].forEach(type => {
                        if (data[type]) {
                            for (const key in data[type]) {
                                const element = document.getElementById(`${type}_${key}`);
                                if (element && data[type][key] !== undefined) {
                                    element.value = data[type][key];
                                }
                            }
                        }
                    });
                    if (data.package) {
                         document.getElementById('tracking_number').value = data.package.tracking_number || '';
                         document.getElementById('cod_amount').value = data.package.cod_amount || 0;
                    }
                    renderLabel();
                }
            } catch (error) {
                console.error("Error loading form data:", error);
            }
        }

        // --- Label Rendering ---

        window.renderLabel = () => {
            const data = getFormData();
            const labelContainer = document.getElementById('shipping-label-preview');
            const codDisplay = data.package.cod_amount > 0 ? `<div class="bg-red-500 text-white text-center font-bold text-lg p-1 mt-2">‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á ${parseFloat(data.package.cod_amount).toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",")} ‡∏ö‡∏≤‡∏ó</div>` : '';
            const recipientFullAddress = [
                data.recipient.address,
                data.recipient.subdistrict,
                data.recipient.district,
                data.recipient.province,
                data.recipient.zipcode
            ].filter(Boolean).join(' ');

            const senderFullAddress = [
                data.sender.address,
                data.sender.subdistrict,
                data.sender.district,
                data.sender.province,
                data.sender.zipcode
            ].filter(Boolean).join(' ');

            labelContainer.innerHTML = `
                <div class="flex flex-col h-full">
                    <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏ö‡∏ô: ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏ / COD -->
                    <div class="flex justify-between items-center border-b border-dashed pb-2">
                        <div class="text-xs font-semibold">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏™‡∏î‡∏∏:</div>
                        <div class="text-sm font-bold text-gray-800">${data.package.tracking_number}</div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö -->
                    <div class="mt-3 border-b border-dashed pb-3 flex-grow">
                        <div class="text-xs font-bold text-red-600 mb-1">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö (RECIPIENT)</div>
                        <div class="font-bold text-lg leading-tight">${data.recipient.name}</div>
                        <div class="text-sm mt-1">‡πÇ‡∏ó‡∏£: ${data.recipient.phone}</div>
                        <div class="text-sm mt-1">${recipientFullAddress}</div>
                        <div class="text-4xl font-extrabold text-center mt-3 p-1 border-2 border-black rounded-lg bg-gray-100">${data.recipient.zipcode}</div>
                    </div>

                    <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á -->
                    <div class="mt-3">
                        <div class="text-xs font-bold text-gray-600 mb-1">‡∏ú‡∏π‡πâ‡∏™‡πà‡∏á (SENDER)</div>
                        <div class="text-sm font-semibold leading-tight">${data.sender.name}</div>
                        <div class="text-xs">‡πÇ‡∏ó‡∏£: ${data.sender.phone}</div>
                        <div class="text-xs">${senderFullAddress}</div>
                    </div>

                    ${codDisplay}
                </div>
            `;
        };

        // --- Zip Code Data Import and Lookup (New Logic) ---

        /**
         * Parses CSV text into an array of objects.
         * Assumes the first row is the header.
         * @param {string} csvText - The raw CSV content.
         * @returns {Array<Object>} Array of objects.
         */
        function parseCSV(csvText) {
            const lines = csvText.split('\n').filter(line => line.trim() !== '');
            if (lines.length === 0) return [];

            const headers = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === headers.length) {
                    let obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = values[index];
                    });
                    data.push(obj);
                }
            }
            return data;
        }


        /**
         * Imports zip code data from the uploaded CSV file.
         */
        window.importZipCodeData = async () => {
            const button = document.getElementById('importZipCodeButton');
            button.disabled = true;
            button.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤...`;

            try {
                // 1. Check for file access
                if (typeof __files === 'undefined' || !Array.isArray(__files)) {
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ (Code environment issue).");
                }

                // 2. Find the correct CSV file
                const fileName = 'Thailand Zip Code - Thailand Zip Code.csv';
                const csvFile = __files.find(f => f.fileName === fileName);

                if (!csvFile) {
                    throw new Error(`‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå '${fileName}' ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á`);
                }

                // 3. Fetch file content
                const csvContent = await getContentFetch(csvFile.contentFetchId);

                if (!csvContent || csvContent.length < 100) { // Check for minimal content
                    throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå CSV ‡πÑ‡∏î‡πâ ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ");
                }

                // 4. Parse and store data
                const parsedData = parseCSV(csvContent);
                window.zipCodeData = parsedData;
                
                // Create a lookup map for fast auto-completion
                window.zipCodeLookup.clear();
                window.zipCodeData.forEach(row => {
                    // Use a pipe '|' delimiter for a unique key: Province|District|Subdistrict
                    const key = `${row.province.trim()}|${row.district.trim()}|${row.subdistrict.trim()}`;
                    if (row.zipcode) {
                         // Only store if zipcode exists
                         window.zipCodeLookup.set(key, row.zipcode.trim());
                    }
                });

                showMessage(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (${window.zipCodeData.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)`, 'success');

            } catch (error) {
                console.error("Import Error:", error);
                showMessage(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message || error}`, 'error');
            } finally {
                button.disabled = false;
                button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3.293 8.707a1 1 0 010-1.414l3-3a1 1 0 011.414 0l3 3a1 1 0 01-1.414 1.414L7 7.414V14a1 1 0 11-2 0V7.414L3.707 8.707a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå`;
            }
        };

        /**
         * Attempts to auto-fill the zip code based on province, district, and subdistrict.
         * @param {string} prefix - 'sender' or 'recipient'
         */
        window.handleAddressInput = (prefix) => {
            if (window.zipCodeLookup.size === 0) {
                // showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏õ‡∏£‡∏©‡∏ì‡∏µ‡∏¢‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏µ‡πâ', 'info');
                return; // Do nothing if data is not loaded
            }

            const province = document.getElementById(`${prefix}_province`)?.value.trim();
            const district = document.getElementById(`${prefix}_district`)?.value.trim();
            const subdistrict = document.getElementById(`${prefix}_subdistrict`)?.value.trim();
            const zipCodeField = document.getElementById(`${prefix}_zipcode`);

            if (!province || !district || !subdistrict) {
                return;
            }

            const searchKey = `${province}|${district}|${subdistrict}`;
            const foundZipCode = window.zipCodeLookup.get(searchKey);

            if (foundZipCode) {
                // Found a match, update the zipcode field
                zipCodeField.value = foundZipCode;
                renderLabel();
            }
        };
        
        // --- PDF Download Function ---

        window.downloadLabelPdf = async () => {
            const downloadButton = document.getElementById('downloadPdfButton');
            downloadButton.disabled = true;
            downloadButton.innerHTML = `<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á PDF...`;

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [80, 100] // 80mm x 100mm label size
                });

                // Load Sarabun font to support Thai characters
                // Note: jspdf needs font data embedded, this is a simplified example
                // In a real-world scenario, you would need to add the font using pdf.addFont().
                // For demonstration, we'll rely on the default fonts which may not fully support Thai.
                // We'll proceed with the screenshot approach using html2canvas.

                const input = document.getElementById('shipping-label-preview');
                const canvas = await html2canvas(input, { scale: 3, useCORS: true });
                const imgData = canvas.toDataURL('image/png');

                const imgWidth = 80; // Target width in mm
                const imgHeight = canvas.height * imgWidth / canvas.width; // Maintain aspect ratio

                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                
                const recipientName = getFormData().recipient.name || 'Shipping_Label';
                pdf.save(`${recipientName}_${new Date().toISOString().slice(0, 10)}.pdf`);
                
                showMessage("‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡∏õ‡∏∞‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô PDF ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", 'success');

            } catch (error) {
                console.error("PDF Download Error:", error);
                showMessage("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå PDF", 'error');
            } finally {
                downloadButton.disabled = false;
                downloadButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L10 11.586l1.293-1.293a1 1 0 111.414 1.414l-2 2a1 1 0 01-1.414 0l-2-2a1 1 0 010-1.414zM10 2a1 1 0 011 1v7a1 1 0 11-2 0V3a1 1 0 011-1z" clip-rule="evenodd" /></svg>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î PDF`;
            }
        };

        // Initial render and load data
        window.addEventListener('load', () => {
            renderLabel();
            // Load form data handled by onAuthStateChanged after Firebase init
        });
        
    </script>
</body>
</html>
